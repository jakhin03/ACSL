FROM nginx:latest
# ... (các bước cài đặt SSH và openssh-client)

# Cài đặt PHP và các module cần thiết
RUN apt update -y && apt install -y php-fpm php-cli php-common php-mysql php-gd php-curl php-mbstring php-xml php-zip \
    && rm -rf /var/lib/apt/lists/* # Dọn dẹp cache apt

# --- THÊM KHỐI LỆNH NÀY ---
# Cấu hình quyền cho PHP-FPM socket để Nginx có thể truy cập
RUN PHP_VERSION=$(php -v 2>/dev/null | grep 'PHP' | awk '{print $2}' | cut -d'.' -f1,2) && \
    # Tìm đường dẫn chính xác của file www.conf (có thể khác nhau tùy phiên bản và cách đóng gói)
    WWW_CONF="/etc/php/${PHP_VERSION}/fpm/pool.d/www.conf" && \
    if [ ! -f "$WWW_CONF" ]; then WWW_CONF="/etc/php-fpm.d/www.conf"; fi && \
    if [ ! -f "$WWW_CONF" ]; then echo "Error: www.conf not found at expected paths!" && exit 1; fi && \
    echo "Configuring PHP-FPM socket permissions in $WWW_CONF" && \
    # Đảm bảo chủ sở hữu socket là user www-data (mặc định)
    sed -i 's/^;*listen\.owner = .*$/listen\.owner = www-data/' "$WWW_CONF" && \
    # Đặt nhóm sở hữu socket là user mà Nginx worker chạy (user nginx)
    sed -i 's/^;*listen\.group = .*$/listen\.group = nginx/' "$WWW_CONF" && \
    # Đặt quyền cho socket: rw- cho chủ sở hữu (www-data), rw- cho nhóm (nginx), --- cho người khác
    # 0660 tương ứng với rw-rw----
    sed -i 's/^;*listen\.mode = .*$/listen\.mode = 0660/' "$WWW_CONF" && \
    echo "PHP-FPM socket permissions configured."
# --- KẾT THÚC KHỐI LỆNH NÀY ---


# Xóa cấu hình Nginx mặc định
RUN rm /etc/nginx/conf.d/default.conf

# Sao chép cấu hình Nginx tùy chỉnh
COPY nginx/default.conf /etc/nginx/conf.d/default.conf

# ... (các bước cài đặt Docker Client)

# Sao chép script khởi động và cấp quyền thực thi
COPY startup.sh /usr/local/bin/startup.sh
RUN chmod +x /usr/local/bin/startup.sh

EXPOSE 80
EXPOSE 22

ENTRYPOINT ["/usr/local/bin/startup.sh"]
CMD []